############################
# VARIABLES GLOBALES
############################
variables:
  GIT_DEPTH: "1"
  SONAR_HOST_URL: "http://192.168.168.129:9000"
  MAVEN_CLI_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository --batch-mode"
  DOCKER_DRIVER: overlay2
  

############################
# CACHE
############################
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository/
    - frontend/node_modules/

############################
# STAGES
############################
stages:
  - build-shared
  - test-unitaires
  - security-scan
  - docker-build
  - docker-scan

############################
# 1Ô∏è‚É£ INSTALLATION DES MODULES COMMUNS
############################
install-commons:
  stage: build-shared
  image: maven:3.8.5-openjdk-17
  script:
    - cd backend/common-service && mvn install -DskipTests $MAVEN_CLI_OPTS
    - cd ../common-student && mvn install -DskipTests $MAVEN_CLI_OPTS
    - cd ../common-exam && mvn install -DskipTests $MAVEN_CLI_OPTS

############################
# 2Ô∏è‚É£ TESTS BACKEND + JACOCO
############################
backend-tests:
  stage: test-unitaires
  image: maven:3.8.5-openjdk-17
  needs: ["install-commons"]
  script: |
    cd backend
    for service in answer-service api-gateway-service course-service exam-service user-service eureka-service; do
      echo "========== Testing $service =========="
      cd $service
      mvn test $MAVEN_CLI_OPTS -Dspring.profiles.active=test
      cd ..
    done
  artifacts:
    when: always
    paths:
      - backend/**/target/classes
      - backend/**/target/site/jacoco/jacoco.xml
    expire_in: 1 hour

############################
# 3Ô∏è‚É£ TESTS FRONTEND (ANGULAR)
############################
frontend-tests:
  stage: test-unitaires
  image: node:18-alpine
  script:
    - cd frontend
    - npm install --legacy-peer-deps
    - npm run test -- --coverage --watchAll=false || true
  artifacts:
    when: always
    paths:
      - frontend/coverage/lcov.info
    expire_in: 1 hour
  allow_failure: true

############################
# 4Ô∏è‚É£ SONARQUBE BACKEND
############################
sonarqube-backend:
  stage: security-scan
  image: maven:3.8.5-openjdk-17
  needs:
  - job: backend-tests
    artifacts: true
  script: |
    cd backend
    for service in user-service exam-service answer-service course-service api-gateway-service eureka-service; do
      echo "========== Sonar Backend : $service =========="
      cd $service
      mvn verify sonar:sonar $MAVEN_CLI_OPTS \
        -Dsonar.projectKey=$service \
        -Dsonar.host.url=$SONAR_HOST_URL \
        -Dsonar.login=$SONAR_TOKEN \
        -Dsonar.java.binaries=target/classes \
        -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
        || echo "Sonar failed for $service"
      cd ..
    done
  allow_failure: true
sca-scan-backend:
  stage: security-scan
  image: maven:3.8.5-openjdk-17
  needs: ["backend-tests"]
  script:
    - cd backend
    - |
      for dir in api-gateway-service user-service exam-service course-service answer-service; do
        echo "üîç Scanning $dir..."
        (
          cd $dir && \
          mvn org.owasp:dependency-check-maven:check \
            $MAVEN_CLI_OPTS \
            -Dformat=HTML \
            -DoutputDirectory=target
        ) || echo "SCA failed for $dir"
      done
  artifacts:
    when: always
    paths:
      - backend/**/target/dependency-check-report.html
  allow_failure: true

############################
# 5Ô∏è‚É£ SONARQUBE FRONTEND
############################
sonar-frontend:
  stage: security-scan
  image: 
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  needs: ["frontend-tests"]
  script:
    - cd frontend
    - |
      sonar-scanner \
        -Dsonar.projectKey=devsecops-frontend \
        -Dsonar.projectName=devsecops-frontend \
        -Dsonar.projectVersion=$CI_COMMIT_SHORT_SHA \
        -Dsonar.sources=src \
        -Dsonar.host.url=$SONAR_HOST_URL \
        -Dsonar.login=$SONAR_TOKEN \
        -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
        -Dsonar.exclusions=**/node_modules/**,**/*.spec.ts
  allow_failure: true
sca-scan-frontend:
  stage: security-scan
  image: node:18-alpine
  needs: ["frontend-tests"]
  script:
    - cd frontend
    - echo "SCA Frontend ‚Äî Analyse des d√©pendances NPM (npm audit)"
    - npm ci --legacy-peer-deps
    - npm audit --json > npm-audit-report.json || true
    - npm audit > npm-audit-report.txt || true
    - npm audit --production --audit-level=critical
  artifacts:
    when: always
    paths:
      - frontend/npm-audit-report.json
      - frontend/npm-audit-report.txt
    expire_in: 1 week
  allow_failure: true

############################
# 8Ô∏è‚É£ BUILD LOCAL DOCKER IMAGES
############################
docker-build-local:
  stage: docker-build
  image: docker:24.0
  services:
    - docker:24.0-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: tcp://docker:2375

  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

  script:
    - cd backend
    - |
      for service in answer-service api-gateway-service course-service exam-service user-service eureka-service zuul-service; do
        echo "Building $service"

        IMAGE="$CI_REGISTRY_IMAGE/$service:$CI_COMMIT_SHORT_SHA"

        docker build -t $IMAGE $service
        docker push $IMAGE
      done
    - cd ../frontend
    - IMAGE="$CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA"
    - docker build -t $IMAGE .
    - docker push $IMAGE


############################
# 9Ô∏è‚É£ SCAN DOCKER AVEC TRIVY
############################
docker-trivy-scan:
  stage: docker-scan
  image: aquasec/trivy:0.50.0
  entrypoint: [""]

  needs:
    - docker-build-local

  script:
    - mkdir -p trivy-reports

    - |
      for service in answer-service api-gateway-service course-service exam-service user-service eureka-service zuul-service; do
        
        IMAGE="$CI_REGISTRY_IMAGE/$service:$CI_COMMIT_SHORT_SHA"
        REPORT="trivy-reports/trivy-report-$service.html"

        echo "Scanning $IMAGE"

        trivy image \
          --severity CRITICAL,HIGH \
          --format template \
          --template "@contrib/html.tpl" \
          -o $REPORT \
          $IMAGE || true

      done

    - |
      IMAGE="$CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA"

      trivy image \
        --severity CRITICAL,HIGH \
        --format template \
        --template "@contrib/html.tpl" \
        -o trivy-reports/trivy-report-frontend.html \
        $IMAGE || true

  artifacts:
    paths:
      - trivy-reports/
    expire_in: 1 week

  allow_failure: true


