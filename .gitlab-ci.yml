############################
# VARIABLES GLOBALES
############################
variables:
  GIT_DEPTH: "1"
  SONAR_HOST_URL: "http://192.168.168.129:9000"
  MAVEN_CLI_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository --batch-mode"

############################
# CACHE
############################
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository/
    - frontend/node_modules/

############################
# STAGES
############################
stages:
  - build-shared
  - test-unitaires
  - security-scan

############################
# 1️⃣ INSTALLATION DES MODULES COMMUNS
############################
install-commons:
  stage: build-shared
  image: maven:3.8.5-openjdk-17
  script:
    - cd backend/common-service && mvn install -DskipTests $MAVEN_CLI_OPTS
    - cd ../common-student && mvn install -DskipTests $MAVEN_CLI_OPTS
    - cd ../common-exam && mvn install -DskipTests $MAVEN_CLI_OPTS
  artifacts:
    paths:
      - .m2/repository/com/microservices/
    expire_in: 1 hour

############################
# 2️⃣ TESTS BACKEND + JACOCO
############################
backend-tests:
  stage: test-unitaires
  image: maven:3.8.5-openjdk-17
  needs: ["install-commons"]
  script: |
    cd backend
    for service in answer-service api-gateway-service course-service exam-service user-service eureka-service; do
      echo "========== Testing $service =========="
      cd $service
      mvn test $MAVEN_CLI_OPTS -Dspring.profiles.active=test
      cd ..
    done
  artifacts:
    when: always
    paths:
      - backend/*/target/site/jacoco/jacoco.xml
    expire_in: 1 hour

############################
# 3️⃣ TESTS FRONTEND (ANGULAR)
############################
frontend-tests:
  stage: test-unitaires
  image: node:18-alpine
  script:
    - cd frontend
    - npm install --legacy-peer-deps
    - npm run test -- --coverage --watchAll=false || true
  artifacts:
    when: always
    paths:
      - frontend/coverage/lcov.info
    expire_in: 1 hour
  allow_failure: true

############################
# 4️⃣ SONARQUBE BACKEND
############################
sonarqube-backend:
  stage: security-scan
  image: maven:3.8.5-openjdk-17
  needs: ["backend-tests"]
  script: |
    cd backend
    for service in user-service exam-service answer-service course-service api-gateway-service eureka-service; do
      echo "========== Sonar Backend : $service =========="
      cd $service
      mvn sonar:sonar $MAVEN_CLI_OPTS \
        -Dsonar.projectKey=devsecops-backend-$service \
        -Dsonar.host.url=$SONAR_HOST_URL \
        -Dsonar.login=$SONAR_TOKEN \
        -Dsonar.java.binaries=target/classes \
        -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
        || echo "Sonar failed for $service"
      cd ..
    done
  allow_failure: true

############################
# 5️⃣ SONARQUBE FRONTEND
############################
sonarqube-frontend:
  stage: security-scan
  image: sonarsource/sonar-scanner-cli:5
  needs: ["frontend-tests"]
  script:
    - cd frontend
    - sonar-scanner
      -Dsonar.projectKey=devsecops-frontend
      -Dsonar.sources=src
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.login=$SONAR_TOKEN
      -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
  allow_failure: true